<!DOCTYPE html>
<html>
<head>
  <title> Drug Data Visualization</title>

  <!-- LINKS -->
    {% load static %}
    <script src="https://code.jquery.com/jquery-3.3.0.min.js"></script>
    {% include 'bootstrap_link.html' %}
    <script src={% static 'visual/cytoscape.js-master/dist/cytoscape.min.js' %}></script>
  <!-- Panzoom -->
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <script src={% static 'visual/cytoscape.js-panzoom-master/cytoscape-panzoom.js' %}></script>
    <link rel="stylesheet" type="text/css" href={% static 'visual/cytoscape.js-panzoom-master/cytoscape.js-panzoom.css' %}/>
  <!-- QTIP -->
  <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.css">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.js"></script>
  <script src={% static 'visual/cytoscape.js-qtip-master/cytoscape-qtip.js' %}></script>


    <style type="text/css">
        #cy{
            background-color: rgb(190, 228, 233);
            border-radius: 10px;
            height: 500px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, .25)
        }
        hr{
          border-color: black;
        }
    </style>
</head>

<!-- Functions -->
  <script > 
    function getChemicalData(){
      $.ajax({
        url: "{% url 'chemical_list' %}" ,
        success: function(chem_list){
          console.log("Successfully retrieved API CHEM LIST")
          cy.startBatch();
          for(let i in chem_list){
            cy.add({
              group: 'nodes',
              data:{
                id: chem_list[i][0],
                InChIKey: chem_list[i][1],
                total_effects: chem_list[i][2] 
              },
              classes: 'chemical'
            });
          };
          cy.endBatch();
          
          cy.layout({name:'random'}).run();
        } //End of ajax success function
      });
    }

    function searchNode(){
      let query = document.getElementById('search_box').value;
      let node = cy.getElementById(query);
      let init_x = node.position()['x'];
      let init_y = node.position()['y'];
      console.log("init pos: "+ init_x+","+init_y)

      let node_neighbors = node.closedNeighborhood();
      node_neighbors.style({"background-color":"#00F"});
      node_neighbors.layout({name:"concentric"}).run();

      let curr_x = node.position()['x'];
      let curr_y = node.position()['y'];

      let x_shift = init_x - curr_x;
      console.log("init x: "+init_x);
      console.log("final x: "+curr_x);
      let y_shift = init_y - curr_y;

      console.log("x shift: "+x_shift),
      console.log("y shift: "+y_shift)

      cy.startBatch();
      node_neighbors.shift({
        x: x_shift,
        y: y_shift
      });
  
      cy.center(node);
      cy.zoom({
        level: 5.5,
        position: {
          x: node.position()['x'],
          y: node.position()['y']
        }
      });
      cy.endBatch();
      
    }
  </script>


<body style="background-color:rgb(243, 243, 243)">
  <div class = "container">
      <h2>Drug Data Visualization</h2>
      <button class="btn btn-primary" onclick = "getChemicalData()">Retrieve Data</button>
      <button class="btn btn-default" onclick="cy.layout({name:'random', animate:true}).run()">Random Layout</button>
      <button class="btn btn-default" onclick="cy.layout({name:'grid', animate:true}).run()">Grid Layout</button>
      <button onclick="console.log(cy.zoom())">Zoom Level</button>

      <hr>

      <div class="row">
        <!-- Left Side Bar -->
          <div class="rounded col-sm-2 col-md-2" style="background-color:#ccc; border-radius: 10px;box-shadow: 0px 2px 5px rgba(0, 0, 0, .25)">
              <div class="col-sm-12 col-md-12">
              <h3>Node Search</h3>
              <hr>
              <input type="text" id="search_box" placeholder="Search..." value="119" style="width: 95%"></br>
              <button onclick="searchNode()">Submit</button>
              <hr>
              <button class="btn btn-info btn-block" onclick="cy.reset()">Reset View</button>
              <hr>
              <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Nihil iste quibusdam maiores ab hic ex, porro minus!</p>
              </div>
          </div>

        <!-- Cytoscape Canvas -->
          <div class="cy col-sm-10 col-md-10">
            <div id="cy" class="cy col-sm-12 col-md-12"></div>
          </div>
      </div>
  </div>


  <!-- Bulk Cytoscape Code -->
  <script >
    //Cytoscape Initalization
    var cy = cytoscape({
      container: document.getElementById('cy'),
      style: [
        {
          selector: 'node.chemical',
          style:{
            'background-color': '#333',
            'shape': 'ellipse',
            'width': 3,
            'height': 3,
          },
        },
        {
          selector: 'node.side_effect',
          style:{
            'background-color': '#333',
            'shape': 'diamond',
            'width': 2,
            'height': 2
          },
        },
        {
          selector: 'edge',
          style:{
            width: 0.5,
          }
        }
      ],
      
      minZoom: 0.8,
      maxZoom: 20,
      hideEdgesOnViewport: true,
      textureOnViewport: true,
        
    }); //End of cyto initalization

    //Cytoscape Extensions--------
    cy.panzoom();
  

    //Cytoscape Events-------
    // cy.on('mouseover', 'node', function(event){
    //   let target_node = event.target;

    //   let neighbors = target_node.closedNeighborhood();
    //   console.log(neighbors.length)
    //   let node_neighbors = neighbors.filter('node');
    //   node_neighbors.style({
    //     'background-color' : "#D00"
    //   });
    //   let edge_neighbors = neighbors.filter('edge');
    //   edge_neighbors.style({
    //     'line-color': "#900"
    //   });
    // });
    
    // cy.on('mouseout', 'node', function(event){
    //   let target_node = event.target;

    //   let neighbors = target_node.closedNeighborhood()

    //   let node_neighbors = neighbors.filter('node');
    //   node_neighbors.style({
    //     'background-color' : "#333"
    //   });
    //   let edge_neighbors = neighbors.filter('edge');
    //   edge_neighbors.style({
    //     'line-color': "#AAA"
    //   });
    // });

    cy.on('tap', 'node', function(event){
      console.log("CID: "+ event.target.id());
      if(event.target.hasClass('expanded')){
        let neighbors = event.target.openNeighborhood().filter('node')
        cy.remove(neighbors) //We only remove nodes, that way edges can stay if another node is expanded
        event.target.style({
          'shape':'ellipse',
          'background-color': "#333"
        })
        event.target.removeClass('expanded')
      }
      else{
        let cid = event.target.id().toString();
        $.ajax({
          url: 'api/side_effects/'+cid, //I need a way to call this without hardcoding it.
          success: function(data){
            cy.startBatch();
            for(i in data){
              cy.add([
                {
                  group:'nodes',
                  data: {id: data[i][1], name: data[i][0] },
                  classes: 'side_effect'
                },
                {
                  group: 'edges',
                  data: {id: cid + data[i][1] , target: data[i][1], source: event.target.id()}
                }
              ]);
            };
            let neighbors = event.target.openNeighborhood();
            let node_neighbors = neighbors.filter('node');
            node_neighbors.style({
              'background-color' : "#D00"
            });
            let edge_neighbors = neighbors.filter('edge');
            edge_neighbors.style({
              'line-color': "#900"
            });
            event.target.style({
              'shape':'star'
            });

            cy.endBatch();
            $(neighbors.layout({name:'concentric', animate:true}).run());
            event.target.addClass('expanded')
          }
        }); //End of AJAX call
      } //End of else statement
    });

    //QTIP events
    cy.on('add', 'node.chemical', function(event){
      event.target.qtip({
        content: {
          title: function(){return("CID: "+ this.id())},
          text: function(){
            let str_rep = "";
            str_rep += "InChIKey: "+ this.data("InChIKey")+ "</br>";
            str_rep += "Total Side Effects: "+ this.data('total_effects');
            return str_rep
          },
        },
        position:{
          at: 'top-right',
          my: 'bottom-center'
        },
        show:{
          event: 'mouseover'
        },
        hide:{
          event: 'mouseout unfocus', //unfocus
        },
        style:{
          classes: 'qtip-tipsy qtip-shadow qtip-rounded '
        }
      });
    });

    cy.on('add', 'node.side_effect', function(event){
      event.target.qtip({
        content: {
          title: function(){return("CID: "+ this.id())},
          text: function(){
            return 'Effect: [' + this.data('name') + ']'
          },
        },
        position:{
          at: 'top-right',
          my: 'bottom-center'
        },
        show:{
          event: 'mouseover'
        },
        hide:{
          event: 'mouseout unfocus', //unfocus
        },
        style:{
          classes: 'qtip-tipsy qtip-shadow qtip-rounded '
        }
      });
    });

  </script>

</body>
</html>